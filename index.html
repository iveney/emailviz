<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>CS467 Email Visualization</title>
	<meta name="author" content="Zigang Xiao">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	html { height: 100% }
	body { height: 100%; margin: 0; padding: 0 }
	#map_canvas { height: 100% }
	</style>
	<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJhUll_iwS__fkFsjn1Flh6JaU6hOUw2o&sensor=false">
	</script>
	<script type="text/javascript">

	// initialize google map objects and center at US
	function initialize() {
		var mapOptions = {
			center: new google.maps.LatLng(-34.397, 150.644),
			zoom: 8,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};

		// Note: declare the map as global object so that it can be accessed later
		window.map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);

		// set the center to US
		var country = "United States";
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode( { 'address': country}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
					if (results && results[0] && results[0].geometry && results[0].geometry.viewport) 
					map.fitBounds(results[0].geometry.viewport);
				} else {
					alert("No results found");
				}
			} else {
				alert("Geocode was not successful for the following reason: " + status);
			}
		});
		google.maps.event.addDomListener(window, 'load', initialize);
		
		// remember the last opened info window
		lastOpenedInfoWindow = null;
	}
	
	function updateValue(val) {
	      document.getElementById('yearText').value = val; 
	}
	
	var circlesArray = [];
	
	function clearCircles() {
		if (circlesArray) {
			for (i in circlesArray) {
				circlesArray[i].setMap(null);
			}
		}
	}
	
	// the following two functions are from
	// http://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-jquery-javascript
	function hashCode(str) { // java String#hashCode
	    var hash = 0;
	    for (var i = 0; i < str.length; i++) {
	       hash = str.charCodeAt(i) + ((hash << 5) - hash);
	    }
	    return hash;
	}
	
	function intToRGB(i){
	    return ((i>>16)&0xFF).toString(16) + 
	           ((i>>8)&0xFF).toString(16) + 
	           (i&0xFF).toString(16);
	}
	
	// TODO: size the dots according to the largest value
	// TODO: add description of dot when mouse over
	function addCircle(latLng, color, count) {
		var dotOpt = {
			strokeColor: color,
			strokeOpacity: 0.8,
			strokeWeight: 2,
			fillColor: color,
			fillOpacity: 0.7,
			map: window.map,
			center: latLng,
			position: latLng,
			radius: Math.sqrt(count) * 10000
		};
		var locCircle = new google.maps.Circle(dotOpt);
		circlesArray.push(locCircle);
		return locCircle;
	}
	
	function addInfoWindow(circle, contentString) {
		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});
		
		google.maps.event.addListener(circle, 'click', function(event) {
			if (lastOpenedInfoWindow != null) lastOpenedInfoWindow.close();
	        infowindow.open(circle.get('map'), circle);
			lastOpenedInfoWindow = infowindow;
        });
	}
	
	// update the map according to year
	function updateMap(year) {
		// remove all previous circles
		clearCircles();
		
		// for each location get the counts
		for (var loc in locations) {
			latLng = loc.split(' ');
			gLatLng = new google.maps.LatLng(latLng[0], latLng[1]);
			var count = 0;
			var temp = "";
			for (var y in locations[loc]) {
				if (parseInt(y) <= year) {
					emailsInYear = parseInt(locations[loc][y]);
					count += emailsInYear;
					temp += y + ": " + emailsInYear + "<br>";
				}
			}
			if (count == 0) continue;
			
			// display in the map
			var color = "#" + intToRGB(hashCode(loc));
			var circle = addCircle(gLatLng, color, count);
			var contentString = "Total: " + count + "<br>" + temp;
			
			// creates an info window for this location
			addInfoWindow(circle, contentString);
		}
	}
	
	</script>
	<!-- Date: 2013-01-30 -->
</head>
<body onload="initialize()">
	<input type="file" id="files" name="files[]" />
	<span id="miny">1900</span>
	<input type="range" id="years" value="1900" min="1900" max="2013" onchange="updateValue(this.value);updateMap(this.value);">
	<span id="maxy">2013</span>
	<input type="text" id="yearText" value="1900">
	<!-- <p><output id="content">File contents will be displayed here.</output></p> -->

	<script>
	// reads the file content
	function handleFileSelect(evt) {
		var files = evt.target.files; // FileList object
		var f = files[0];	// only one file
		var reader = new FileReader();  

		// closure to do the drawing
		reader.onload = (function(theFile) {
			return function(e) {
				// DEBUG: display the content
				// document.getElementById('content').innerHTML = "<pre>"+e.target.result+"</pre>";
				locations = {};
				var miny = 2013;
				var maxy = 1900;
				lines = e.target.result.split("\n");
				// todo:
				// use location[year] = {loc1 : num, loc2: num} to store
				// to visualize up to year 2007, just sum up the nums of the locations before 2007.
				// may need to use a hash to store the counts
				
				// first line is CSV description
				for (var i = 1; i < lines.length; i++) {
					if (lines[i] == "") continue;
					data = lines[i].split(',');
					// use latitude and longitude as key
					var latLng = data[1]+' '+data[2];
					var year = data[0];
					
					// update year range
					if (year < miny) miny = year;
					if (year > maxy) maxy = year;
					
					// update data
					if(! (latLng in locations)) {
						locations[latLng] = {};
					}
					if(! (year in locations[latLng])) locations[latLng][year] = 0;
					locations[latLng][year]++;
				}
				console.log(window.locations);
			    
				// update slider
				var slider = document.getElementById('years');
				slider.min = miny;
				slider.max = maxy;
				slider.value = miny;
				document.getElementById('miny').innerHTML = miny;
				document.getElementById('maxy').innerHTML = maxy;
				
				slider.onchange();
			};
			})(f);	// end closure

		reader.readAsText(f);
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
	</script>

	<div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>

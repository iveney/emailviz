<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>CS467 Email Visualization</title>
	<meta name="author" content="Zigang Xiao">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	html { height: 100% }
	body { height: 100%; margin: 0; padding: 0 }
	#map_canvas { height: 100% }
	</style>
	<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJhUll_iwS__fkFsjn1Flh6JaU6hOUw2o&sensor=false">
	</script>
	<script type="text/javascript">

	// initialize google map objects and center at US
	function initialize() {
		var mapOptions = {
			center: new google.maps.LatLng(-34.397, 150.644),
			zoom: 8,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};

		// Note: declare the map as global object so that it can be accessed later
		window.map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);

		// set the center to US
		var country = "United States";
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode( { 'address': country}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
					if (results && results[0] && results[0].geometry && results[0].geometry.viewport) 
					map.fitBounds(results[0].geometry.viewport);
				} else {
					alert("No results found");
				}
			} else {
				alert("Geocode was not successful for the following reason: " + status);
			}
		});
		google.maps.event.addDomListener(window, 'load', initialize);
		
		// remember the last opened info window
		lastOpenedInfoWindow = null;
	}
	
	function updateValue(val) {
	      document.getElementById('yearText').value = val; 
	}
	
	var circlesArray = [];
	
	function clearCircles() {
		if (circlesArray) {
			for (i in circlesArray) {
				circlesArray[i].setMap(null);
			}
		}
	}
	
	// the following two functions are from
	// http://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-jquery-javascript
	function hashCode(str) { // java String#hashCode
	    var hash = 0;
	    for (var i = 0; i < str.length; i++) {
	       hash = str.charCodeAt(i) + ((hash << 5) - hash);
	    }
	    return hash;
	}
	
	function intToRGB(i){
	    return ((i>>16)&0xFF).toString(16) + 
	           ((i>>8)&0xFF).toString(16) + 
	           (i&0xFF).toString(16);
	}
	
	// TODO: size the dots according to the largest value
	// TODO: add description of dot when mouse over
	function addCircle(latLng, color, count) {
		var dotOpt = {
			strokeColor: color,
			strokeOpacity: 0.8,
			strokeWeight: 2,
			fillColor: color,
			fillOpacity: 0.7,
			map: window.map,
			center: latLng,
			position: latLng,
			radius: Math.sqrt(count) * 10000
		};
		var locCircle = new google.maps.Circle(dotOpt);
		circlesArray.push(locCircle);
		return locCircle;
	}
	
	function addInfoWindow(circle, contentString) {
		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});
		
		google.maps.event.addListener(circle, 'click', function(event) {
			if (lastOpenedInfoWindow != null) lastOpenedInfoWindow.close();
	        infowindow.open(circle.get('map'), circle);
			lastOpenedInfoWindow = infowindow;
        });
	}
	
	/**
	 * Converts an HSL color value to RGB. Conversion formula
	 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
	 * Assumes h, s, and l are contained in the set [0, 1] and
	 * returns r, g, and b in the set [0, 255].
	 *
	 * @param   Number  h       The hue
	 * @param   Number  s       The saturation
	 * @param   Number  l       The lightness
	 * @return  Array           The RGB representation
	 */
	function hslToRgb(h, s, l){
	    var r, g, b;

	    if(s == 0){
	        r = g = b = l; // achromatic
	    }else{
	        function hue2rgb(p, q, t){
	            if(t < 0) t += 1;
	            if(t > 1) t -= 1;
	            if(t < 1/6) return p + (q - p) * 6 * t;
	            if(t < 1/2) return q;
	            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
	            return p;
	        }

	        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
	        var p = 2 * l - q;
	        r = hue2rgb(p, q, h + 1/3);
	        g = hue2rgb(p, q, h);
	        b = hue2rgb(p, q, h - 1/3);
	    }

	    return [r * 255, g * 255, b * 255];
	}
	
	// range of sentiment is from 1 to 3
	// need to scale to the range [0, .66] (Red to blue)
	function getRGBFromSentiment(sentiment) {
		function componentToHex(c) {
		    var hex = c.toString(16);
		    return hex.length == 1 ? "0" + hex : hex;
		}

		function rgbToHex(r, g, b) {
		    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
		}
		
		var h = (sentiment - 1.0) / 2.0 * 0.66;
		var s = 1.0;
		var l = 0.5;
		// console.log("sentiment = " + sentiment);
		// console.log("h = " + h);
		
		var rgb = hslToRgb(h, s, l);
		var r = (rgb[0] & 0xFF);
		var g = (rgb[1] & 0xFF);
		var b = (rgb[2] & 0xFF);
		return rgbToHex(r,g,b);
	}
	
	// update the map according to year
	function updateMap(year) {
		// remove all previous circles
		clearCircles();
		
		// for each location get the counts
		for (var loc in locations) {
			latLng = loc.split(' ');
			gLatLng = new google.maps.LatLng(latLng[0], latLng[1]);
			var count = 0;
			var temp = "";
			var sentiment = 0.0;
			var span = 0;
			for (var y in locations[loc]) {
				if (parseInt(y) <= year) {
					span++;
					emailsInYear = parseInt(locations[loc][y]['count']);
					count += emailsInYear;
					temp += y + ": " + emailsInYear + "<br>";
					sentiment += locations[loc][y]['sentiment'];
				}
			}
			if (count == 0) continue;
			sentiment /= span;
			
			// display in the map
			// var color = "#" + intToRGB(hashCode(loc));
			var color = getRGBFromSentiment(sentiment);
			var circle = addCircle(gLatLng, color, count);
			var contentString = "Total: " + count + ", sentiment = " + sentiment.toFixed(2) + "<br>" + temp;
			
			// creates an info window for this location
			addInfoWindow(circle, contentString);
		}
	}
	
	</script>
	<!-- Date: 2013-01-30 -->
</head>
<body onload="initialize()">
	<input type="file" id="files" name="files[]" />
	<span id="miny">1900</span>
	<input type="range" id="years" value="1900" min="1900" max="2013" onchange="updateValue(this.value);updateMap(this.value);">
	<span id="maxy">2013</span>
	<input type="text" id="yearText" value="1900">
	<!-- <p><output id="content">File contents will be displayed here.</output></p> -->

	<script>
	// reads the file content
	function handleFileSelect(evt) {
		var files = evt.target.files; // FileList object
		var f = files[0];	// only one file
		var reader = new FileReader();  

		// closure to do the drawing
		reader.onload = (function(theFile) {
			return function(e) {
				// DEBUG: display the content
				// document.getElementById('content').innerHTML = "<pre>"+e.target.result+"</pre>";
				locations = {};
				var miny = 2013;
				var maxy = 1900;
				lines = e.target.result.split("\n");
				
				// first line is CSV description
				for (var i = 1; i < lines.length; i++) {
					if (lines[i] == "") continue;
					data = lines[i].split(',');
					// use latitude and longitude as key
					var latLng = data[1]+' '+data[2];
					var year = data[0];
					var sentiment = parseFloat(data[3]);
					
					// update year range
					if (year < miny) miny = year;
					if (year > maxy) maxy = year;
					
					// update data
					if(! (latLng in locations)) {
						locations[latLng] = {};
					}
					if(! (year in locations[latLng])) {
						locations[latLng][year] = {};
						locations[latLng][year]['count'] = 0;
						locations[latLng][year]['sentiment'] = 2.0;
					}
					locations[latLng][year]['count']++;
					locations[latLng][year]['sentiment'] = 
						(locations[latLng][year]['sentiment'] + sentiment)/2;
				}
				console.log(window.locations);
			    
				// update slider
				var slider = document.getElementById('years');
				slider.min = miny;
				slider.max = maxy;
				slider.value = miny;
				document.getElementById('miny').innerHTML = miny;
				document.getElementById('maxy').innerHTML = maxy;
				
				slider.onchange();
			};
			})(f);	// end closure

		reader.readAsText(f);
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
	</script>

	<div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>
